{% extends 'base.html' %}
{% load npda_tags %}
{% csrf_token %}
{% block content %}
  <div class="flex justify-center bg-white py-8">
    <div class="max-w-full lg:max-w-[75%] px-2 bg-white font-montserrat">
      <strong>
        {{ title }} - NHS Number {{ nhs_number }}
      </strong>
      <form id="update-form"
            method="post"
            {% if form_method == "create" %} action="{% url 'visit-create' patient_id %}" {% else %} action="{% url 'visit-update' patient_id=patient_id pk=visit.pk %}" {% endif %}>
        {% csrf_token %}
        {% for field in form %}
          {% if field.field.category is None %}
            <!-- visit date box -->
            <div class="md:flex md:items-center mb-6 mt-2 {% if background_colour %}bg-{{ background_colour }}{% endif %}">
              <div class="md:w-1/3">
                <label for="{{ field.id_for_label }}"
                       class="block text-gray-700 font-bold md:text-right mb-1 md:mb-0 pr-4">
                  <small>{{ field.label }}</small>
                </label>
              </div>
              <div class="flex space-between md:w-2/3">
                {% if field.id_for_label == "id_visit_date" %}
                  <input type="date" id="{{ field.id_for_label }}" name="{{ field.html_name }}" class="input rcpch-input-text {% if not can_alter_this_audit_year_submission or not can_complete_questionnaire %}opacity-40 pointer-events-none{% endif %}" {% if field.value %}value={{ field.value|stringformat:'s' }}{% endif %}>
                  <button type='button'
                          _="on click set #{{ field.id_for_label }}'s value to '{% today_date %}'"
                          class="btn rcpch-btn bg-rcpch_light_blue border border-rcpch_light_blue hover:bg-rcpch_strong_blue hover:border-rcpch_strong_blue {% if not can_alter_this_audit_year_submission or not can_complete_questionnaire %}opacity-40 pointer-events-none{% endif %}">
                    Today
                  </button>
                {% endif %}
                {% for error in field.errors %}
                  <p>
                    <strong class="text-gray-700">{{ error|escape }}</strong>
                  </p>
                {% endfor %}
              </div>
            </div>
          {% endif %}
        {% endfor %}
        <div role="tablist" class="flex flex-wrap">
          <input type="radio"
                 name="my_tabs_1"
                 role="tab"
                 class="order-1 basis-full md:basis-1/3 tab font-bold mb-2 text-black border-b-4 hover:border-b-rcpch_pink border-b-rcpch_light_blue_tint3 border-solid border-0  {% if routine_measurements_categories_with_errors and form_method == 'update' %} bg-rcpch_red {% else %} bg-rcpch_light_blue {% endif %}"
                 aria-label="Routine&nbsp;Measurements"
                 checked />
          <!-- This is the Routine measurements tab -->
          <div role="tabpanel" class="tab-content order-4 basis-full rounded-none">
            <div class="flex align-middle items-center bg-gray-100 p-2 m-2">
              <span class="mr-2 text-nowrap"><i class="fa-solid fa-list"></i> Skip to section: </span>
              <ul class="flex gap-2 flex-wrap my-2">
                {% for field_category in form.categories %}
                  {% with field_category|colour_for_category as background_colour %}
                    {% if field_category == "Measurements" or field_category == "HBA1c" or field_category == "Treatment" or field_category == "CGM" or field_category == "BP" %}
                      <li class="inline-block p-2 font-mono bg-{{ background_colour }} hover:shadow-md hover:underline">
                        <a href="#{{ field_category|cut:" " }}_anchor">
                          {% if field_category|category_has_errors:visit_instance.errors %}
                            <span class="fa-stack text-rcpch_red">
                              <i class="fa-circle fa-stack-1x fas"></i>
                              <i class="fa-exclamation fa-stack-1x fa-inverse fas"></i>
                            </span>
                          {% endif %}
                          {{ field_category }}
                        </a>
                      </li>
                    {% endif %}
                  {% endwith %}
                {% endfor %}
              </ul>
            </div>
            {% for field_category in form.categories %}
              {% with field_category|colour_for_category as background_colour %}
                {% if field_category == "Measurements" or field_category == "HBA1c" or field_category == "Treatment" or field_category == "CGM" or field_category == "BP" %}
                  <div class="flex flex-col mb-6 {% if background_colour %}bg-white{% endif %} {% if field_category in routine_measurements_categories_with_errors %} outline outline-4 outline-rcpch_red {% endif %} border-4 border-{{ background_colour }} ">
                    <a name="{{ field_category|cut:" " }}_anchor"></a>
                    <div class="badge badge-outline p-2 {% if background_colour %}bg-{{ background_colour }}{% endif %} text-white">
                      {{ field_category }}
                    </div>
                    {% for field in form %}
                      {% if field.field.category == field_category %}
                        <div class="flex flex-row flex-wrap my-2 mx-2">
                          <div class="flex items-center justify-start w-full md:w-1/3">
                            {% is_not_excluded_centile_field field as included_field %}
                            {% if included_field %}
                              <label for="{{ field.id_for_label }}"
                                     class="block text-gray-700 font-bold mb-1 md:mb-0 pr-4">
                                <small>{{ field.label }}</small>
                              </label>
                            {% endif %}
                          </div>
                          <div class="flex justify-end w-full md:w-2/3 flex-wrap">
                            {% if field.field.widget|is_select %}
                              <select id="{{ field.id_for_label }}"
                                      name="{{ field.html_name }}"
                                      class="select rcpch-select rounded-none {% if not can_alter_this_audit_year_submission or not can_complete_questionnaire %}opacity-40 pointer-events-none{% endif %}">
                                {% for choice in field.field.choices %}
                                  <option value="{{ choice.0 }}"
                                          {% if field.value|stringformat:'s' == choice.0|stringformat:'s' %} selected="{{ field.value }}" {% endif %}>
                                    {{ choice.1 }}
                                  </option>
                                {% endfor %}
                              </select>
                            {% elif field.field.widget|is_dateinput %}
                              <input type="date" id="{{ field.id_for_label }}" name="{{ field.html_name }}" class="input rcpch-input-text flex-grow basis-2/3 {% if not can_alter_this_audit_year_submission or not can_complete_questionnaire %}opacity-40 pointer-events-none{% endif %}" {% if field.value %}value={{ field.value|stringformat:'s' }}{% endif %}>
                              <div class="basis-1/3 flex">
                                <button type='button'
                                        _="on click set #{{ field.id_for_label }}'s value to '{% today_date %}'"
                                        class="btn rcpch-btn bg-rcpch_light_blue border border-rcpch_light_blue hover:bg-rcpch_strong_blue hover:border-rcpch_strong_blue {% if not can_alter_this_audit_year_submission or not can_complete_questionnaire %}opacity-40 pointer-events-none{% endif %}">
                                  Today
                                </button>
                                <button type='button'
                                        _="on click set #{{ field.id_for_label }}'s value to #id_visit_date.value"
                                        class="btn rcpch-btn bg-rcpch_light_blue border border-rcpch_light_blue hover:bg-rcpch_strong_blue hover:border-rcpch_strong_blue {% if not can_alter_this_audit_year_submission or not can_complete_questionnaire %}opacity-40 pointer-events-none{% endif %}">
                                  Fill with Visit Date
                                </button>
                              </div>
                            {% else %}
                              <!-- these are the field inputs: do not want to show centile/sds  -->
                              {% is_not_excluded_centile_field field as included_field %}
                              {% if included_field or field.id_for_label == 'id_bmi' %}
                                {% if field.id_for_label == 'id_bmi' %}
                                  <label for="{{ field.id_for_label }}"
                                         class="block text-gray-700 font-bold mb-1 md:mb-0 pr-4">
                                    <small>Body Mass Index: {{ field.value }} kg/mÂ²</small>
                                  </label>
                                {% else %}
                                  <input type="text" id="{{ field.id_for_label }}" name="{{ field.html_name }}" class="input rcpch-input-text rounded-none {% if not can_alter_this_audit_year_submission or not can_complete_questionnaire %}opacity-40 pointer-events-none{% endif %}" {% if field.field.required %}placeholder="Required"{% endif %} {% if field.value %} value={{ field.value }} {% elif field.value == 0 %} value="0.0" {% endif %}>
                                {% endif %}
                                {% centile_sds field as centile_sds %}
                                {% with centile=centile_sds.0 sds=centile_sds.1 %}
                                  {% if centile %}
                                    <span>
                                      <label>
                                        <small>Centile: {{ centile }}</small>
                                      </label>
                                      <label>
                                        <small>SDS: {{ sds }}</small>
                                      </label>
                                    {% endif %}
                                  </span>
                                {% endwith %}
                              {% endif %}
                            {% endif %}
                            {% for error in field.errors %}
                              <p>
                                <strong class="text-gray-700">{{ error|escape }}</strong>
                              </p>
                            {% endfor %}
                          </div>
                        </div>
                      {% endif %}
                    {% endfor %}
                    {% if field_category in categories_with_errors %}
                      <div>
                        <p class="text-rcpch_red_dark_tint italic font-bold">Errors for category:</p>
                        <p class="text-rcpch_red_dark_tint italic">
                          {{ field_category|errors_for_category:visit_instance.errors|safe|linebreaksbr }}
                        </p>
                      </div>
                    {% endif %}
                  </div>
                {% endif %}
              {% endwith %}
            {% endfor %}
          </div>
          <input type="radio"
                 name="my_tabs_1"
                 role="tab"
                 class="order-2  basis-full md:basis-1/3 tab rounded-none font-bold mb-2 text-black border-b-4 hover:border-b-rcpch_pink border-b-rcpch_light_blue_tint3 border-solid border-0 {% if annual_review_categories_with_errors and form_method == 'update' %} bg-rcpch_red {% else %} bg-rcpch_light_blue {% endif %}"
                 aria-label="Annual&nbsp;Review" />
          <!-- This is the the annual review tab -->
          <div role="tabpanel" class="tab-content order-5 basis-full rounded-none">
            <div class="flex align-middle items-center bg-gray-100 p-2 m-2">
              <span class="mr-2 text-nowrap"><i class="fa-solid fa-list"></i> Skip to section: </span>
              <ul class="flex gap-2 flex-wrap my-2">
                {% for field_category in form.categories %}
                  {% with field_category|colour_for_category as background_colour %}
                    {% if field_category == "Foot Care" or field_category == "DECS" or field_category == "ACR" or field_category == "Cholesterol" or field_category == "Thyroid" or field_category == "Coeliac" or field_category == "Psychology" or field_category == "Smoking" or field_category == "Dietician" or field_category == "Sick Day Rules" or field_category == "Immunisation (flu)" %}
                      <li class="inline-block p-2 font-mono bg-{{ background_colour }} hover:shadow-md hover:underline">
                        <a href="#{{ field_category|cut:" " }}_anchor">
                          {% if field_category|category_has_errors:visit_instance.errors %}
                            <span class="fa-stack text-rcpch_red">
                              <i class="fa-circle fa-stack-1x fas"></i>
                              <i class="fa-exclamation fa-stack-1x fa-inverse fas"></i>
                            </span>
                          {% endif %}
                          {{ field_category }}
                        </a>
                      </li>
                    {% endif %}
                  {% endwith %}
                {% endfor %}
              </ul>
            </div>
            {% for field_category in form.categories %}
              {% with field_category|colour_for_category as background_colour %}
                {% if field_category == "Foot Care" or field_category == "DECS" or field_category == "ACR" or field_category == "Cholesterol" or field_category == "Thyroid" or field_category == "Coeliac" or field_category == "Psychology" or field_category == "Smoking" or field_category == "Dietician" or field_category == "Sick Day Rules" or field_category == "Immunisation (flu)" %}
                  <div class="collapse collapse-open mb-2 rounded-none {% if field_category in categories_with_errors %} border-4 border-rcpch_red {% else %} border-4 border-{{ background_colour }} {% endif %} ">
                    <input type="checkbox" class="peer" name="my-accordion-3" />
                    <div class="collapse-title p-1 pt-0 pl-0 m-0 pr-12">
                      <a name="{{ field_category|cut:" " }}_anchor"></a>
                      {% if field_category in categories_with_errors %}
                        <div class="badge badge-outline badge-rcpch_red text-white bg-rcpch_red">
                          {{ field_category }}
                        </div>
                      {% else %}
                        <div class="badge badge-outline bg-{{ background_colour }} text-white">
                          {{ field_category }}
                        </div>
                      {% endif %}
                    </div>
                    <div class="collapse-content flex flex-col bg-white">
                      {% for field in form %}
                        {% if field.field.category == field_category %}
                          <div class="flex flex-wrap flex-row my-2 mx-2">
                            <div class="flex items-center justify-start  md:w-1/3 w-full ">
                              <label for="{{ field.id_for_label }}"
                                     class="text-black block font-bold mb-1 md:mb-0 pr-4 text-left">
                                <small>{{ field.label }}</small>
                              </label>
                            </div>
                            <div class="flex justify-end w-full md:w-2/3 flex-wrap">
                              {% if field.field.widget|is_select %}
                                <select id="{{ field.id_for_label }}"
                                        name="{{ field.html_name }}"
                                        class="select rcpch-select rounded-none">
                                  {% for choice in field.field.choices %}
                                    <option value="{{ choice.0 }}"
                                            {% if field.value|stringformat:'s' == choice.0|stringformat:'s' %} selected="{{ field.value }}" {% endif %}>
                                      {{ choice.1 }}
                                    </option>
                                  {% endfor %}
                                </select>
                              {% elif field.field.widget|is_dateinput %}
                                <input type="date" id="{{ field.id_for_label }}" name="{{ field.html_name }}" class="input rcpch-input-text flex-grow basis-2/3 {% if not can_alter_this_audit_year_submission or not can_complete_questionnaire %}opacity-40 pointer-events-none{% endif %}" {% if field.value %}value={{ field.value|stringformat:'s' }}{% endif %}>
                                <div class="basis-1/3 flex">
                                  <button type='button'
                                          _="on click set #{{ field.id_for_label }}'s value to '{% today_date %}'"
                                          class="btn rcpch-btn bg-rcpch_light_blue border border-rcpch_light_blue hover:bg-rcpch_strong_blue hover:border-rcpch_strong_blue {% if not can_alter_this_audit_year_submission or not can_complete_questionnaire %}opacity-40 pointer-events-none{% endif %}">
                                    Today
                                  </button>
                                  <button type='button'
                                          _="on click set #{{ field.id_for_label }}'s value to #id_visit_date.value"
                                          class="btn rcpch-btn bg-rcpch_light_blue border border-rcpch_light_blue hover:bg-rcpch_strong_blue hover:border-rcpch_strong_blue {% if not can_alter_this_audit_year_submission or not can_complete_questionnaire %}opacity-40 pointer-events-none{% endif %}">
                                    Fill with Visit Date
                                  </button>
                                </div>
                              {% else %}
                                <input type="text" id="{{ field.id_for_label }}" name="{{ field.html_name }}" class="input rcpch-input-text rounded-none{% if not can_alter_this_audit_year_submission or not can_complete_questionnaire %}opacity-40 pointer-events-none{% endif %}" {% if field.field.required %}placeholder="Required"{% endif %} {% if field.value %} value={{ field.value }} {% elif field.value == 0 %} value="0.0" {% endif %}>
                              {% endif %}
                              {% for error in field.errors %}
                                <p>
                                  <strong class="text-rcpch_red">{{ error|escape }}</strong>
                                </p>
                              {% endfor %}
                            </div>
                          </div>
                        {% endif %}
                      {% endfor %}
                      {% if field_category in categories_with_errors %}
                        <div>
                          <small class="text-rcpch_red italic font-bold">Errors for category:</small>
                          <small class="text-rcpch_red italic">{{ field_category|errors_for_category:visit_instance.errors|safe|linebreaksbr }}</small>
                        </div>
                      {% endif %}
                    </div>
                  </div>
                {% endif %}
              {% endwith %}
            {% endfor %}
          </div>
          <input type="radio"
                 name="my_tabs_1"
                 role="tab"
                 aria-label="Inpatient&nbsp;Entry"
                 class="order-3  basis-full md:basis-1/3 tab font-bold mb-2 text-black border-b-4 hover:border-b-rcpch_pink border-b-rcpch_light_blue_tint3 border-solid border-0 {% if 'Hospital Admission' in categories_with_errors %} bg-rcpch_red {% else %} bg-rcpch_light_blue {% endif %} " />
          <div role="tabpanel" class="tab-content order-5 basis-full rounded-none">
            <div class="flex align-middle items-center bg-gray-100 p-2 m-2">
              <span class="mr-2 text-nowrap"><i class="fa-solid fa-list"></i> Skip to section: </span>
              <ul class="flex gap-2 flex-wrap my-2">
                {% for field_category in form.categories %}
                  {% with field_category|colour_for_category as background_colour %}
                    {% if field_category == "Hospital Admission" %}
                      <li class="inline-block p-2 font-mono bg-{{ background_colour }} hover:shadow-md hover:underline">
                        <a href="#{{ field_category|cut:" " }}_anchor">{{ field_category }}</a>
                      </li>
                    {% endif %}
                  {% endwith %}
                {% endfor %}
              </ul>
            </div>
            {% for field_category in form.categories %}
              {% with field_category|colour_for_category as background_colour %}
                {% if field_category == "Hospital Admission" %}
                  <!-- This is the inpatient entry  -->
                  <div class="flex flex-col mb-6 {% if background_colour %} border-4 border-{{ background_colour }} bg-white {% endif %} {% if 'Hospital Admission' in categories_with_errors %} outline outline-4 outline-rcpch_red {% endif %}">
                    <a name="{{ field_category|cut:" " }}_anchor"></a>
                    <div class="badge badge-outline p-2 {% if background_colour %}bg-{{ background_colour }}{% endif %} text-white">
                      {{ field_category }}
                    </div>
                    {% for field in form %}
                      {% if field.field.category == field_category %}
                        <div class="flex flex-row my-2 mx-2 flex-wrap">
                          <div class="flex items-center justify-start w-full md:w-1/3">
                            <label for="{{ field.id_for_label }}"
                                   class="block text-gray-700 font-bold mb-1 md:mb-0 pr-4">
                              <small>{{ field.label }}</small>
                            </label>
                          </div>
                          <div class="flex justify-end w-full md:w-2/3 flex-wrap">
                            {% if field.field.widget|is_select %}
                              <select id="{{ field.id_for_label }}"
                                      name="{{ field.html_name }}"
                                      class="select rcpch-select rounded-none {% if not can_alter_this_audit_year_submission or not can_complete_questionnaire %}opacity-40 pointer-events-none{% endif %}">
                                {% for choice in field.field.choices %}
                                  <option value="{{ choice.0 }}"
                                          {% if field.value|stringformat:'s' == choice.0|stringformat:'s' %} selected="{{ field.value }}" {% endif %}>
                                    {{ choice.1 }}
                                  </option>
                                {% endfor %}
                              </select>
                            {% elif field.field.widget|is_dateinput %}
                              <input type="date" id="{{ field.id_for_label }}" name="{{ field.html_name }}" class="input rcpch-input-text flex-grow basis-2/3 {% if not can_alter_this_audit_year_submission or not can_complete_questionnaire %}opacity-40 pointer-events-none{% endif %}" {% if field.value %}value={{ field.value|stringformat:'s' }}{% endif %}>
                              <div class="basis-1/3 flex">
                                <button type='button'
                                        _="on click set #{{ field.id_for_label }}'s value to '{% today_date %}'"
                                        class="btn rcpch-btn bg-rcpch_light_blue border border-rcpch_light_blue hover:bg-rcpch_strong_blue hover:border-rcpch_strong_blue {% if not can_alter_this_audit_year_submission or not can_complete_questionnaire %}opacity-40 pointer-events-none{% endif %}">
                                  Today
                                </button>
                                <button type='button'
                                        _="on click set #{{ field.id_for_label }}'s value to #id_visit_date.value"
                                        class="btn rcpch-btn bg-rcpch_light_blue border border-rcpch_light_blue hover:bg-rcpch_strong_blue hover:border-rcpch_strong_blue {% if not can_alter_this_audit_year_submission or not can_complete_questionnaire %}opacity-40 pointer-events-none{% endif %}">
                                  Fill with Visit Date
                                </button>
                              </div>
                            {% else %}
                              <input type="text" id="{{ field.id_for_label }}" name="{{ field.html_name }}" class="input rcpch-input-text rounded-none {% if not can_alter_this_audit_year_submission or not can_complete_questionnaire %}opacity-40 pointer-events-none{% endif %}" {% if field.field.required %}placeholder="Required"{% endif %} {% if field.value %} value={{ field.value }} {% elif field.value == 0 %} value="0.0" {% endif %}>
                            {% endif %}
                            {% for error in field.errors %}
                              <p>
                                <strong class="text-gray-700">{{ error|escape }}</strong>
                              </p>
                            {% endfor %}
                          </div>
                        </div>
                      {% endif %}
                    {% endfor %}
                    {% if field_category in categories_with_errors %}
                      <div>
                        <p class="text-rcpch_red_dark_tint italic font-bold">Errors for category:</p>
                        <p class="text-rcpch_red_dark_tint italic">
                          {{ field_category|errors_for_category:visit_instance.errors|safe|linebreaksbr }}
                        </p>
                      </div>
                    {% endif %}
                  </div>
                {% endif %}
              {% endwith %}
            {% endfor %}
          </div>
        </div>
        <div class="flex justify-end">
          <button type="submit"
                  value="Submit"
                  class="btn rcpch-btn bg-rcpch_light_blue border border-rcpch_light_blue hover:bg-rcpch_strong_blue hover:border-rcpch_strong_blue {% if not can_alter_this_audit_year_submission or not can_complete_questionnaire %}opacity-40 pointer-events-none{% endif %}">
            {{ button_title }}
          </button>
          <a class="btn rcpch-btn bg-rcpch_yellow_light_tint1 border border-rcpch_yellow_light_tint1 hover:bg-rcpch_yellow hover:border-rcpch_yellow"
             href="{% url 'patient_visits' patient_id=patient_id %}">Cancel</a>
          {% if form_method == 'update' and perms.npda.delete_visit %}
            <a class="btn rcpch-btn bg-rcpch_red text-white font-semibold hover:text-white py-2.5 px-3 border border-rcpch_red hover:bg-rcpch_red_dark_tint hover:border-rcpch_red_dark_tint {% if not can_alter_this_audit_year_submission or not can_complete_questionnaire %}opacity-40 pointer-events-none{% endif %}"
               href="{% url 'visit-delete' patient_id visit.pk %}">Delete</a>
          {% endif %}
        </div>
      </form>
    </div>
  </div>
{% endblock %}
