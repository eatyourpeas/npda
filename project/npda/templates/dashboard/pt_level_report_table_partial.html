{% load npda_tags %}

<div id="pt_level_report">
  <div class="flex flex-col gap-4" >

      <div class="flex gap-4 flex-wrap">
        {% include 'dashboard/pt_level_menu_tab_button.html' with selected=highlight.health_checks key='health_checks' button_text='Health Checks' %}
        {% include 'dashboard/pt_level_menu_tab_button.html' with selected=highlight.additional_care_processes key='additional_care_processes' button_text='Additional Care Processes' %}
        {% include 'dashboard/pt_level_menu_tab_button.html' with selected=highlight.care_at_diagnosis key='care_at_diagnosis' button_text='Care at Diagnosis' %}
        {% include 'dashboard/pt_level_menu_tab_button.html' with selected=highlight.outcomes key='outcomes' button_text='Outcomes' %}
        {% include 'dashboard/pt_level_menu_tab_button.html' with selected=highlight.treatment key='treatment' button_text='Treatment' %}
      </div>

      <div class="bg-white border border-gray-300 rounded-lg shadow text-rcpch_dark_blue h-full p-2">
      <!-- CURRENT SELECTION DESCRIPTION -->
      <div class="flex flex-col">
        <p class="font-bold text-rcpch_dark_blue">Description</p>
        <p>
          {{ text.description }}
        </p>
      </div>
      <div class="flex flex-col my-2 gap-2">
        <p class="font-bold text-rcpch_dark_blue">Key</p>
        <div class="flex gap-4">
          <div class="flex gap-2 items-center">
            <i class="fa-solid fa-circle-check text-success"></i>
            <p>Pass</p>
          </div>
          <div class="flex gap-2 items-center">
            <i class="fa-solid fa-circle-exclamation text-error"></i>
            <p>Fail</p>
          </div>
          <div class="flex gap-2 items-center">
            <i class="fa-solid fa-ban text-muted"></i>
            <p>Ineligible</p>
          </div>
        </div>
      </div>
    </div>

    <div class="flex overflow-y-auto {% if table_data.row_data %}h-[60vh]{% endif %} w-full" id="pt_level_report_table">
      <table class="table-auto w-full text-xs  text-center text-gray-500 mb-5 font-montserrat overflow-x-auto">
        <thead class="uppercase bg-rcpch_dark_blue text-white sticky top-0 z-10">
          <tr>
            {% comment %} TODO: ONCE ALL DATA ADDED, REMOVE THIS CHECK {% endcomment %}
            {% if text.headers %}
              {% for header in text.headers %}
              <th class="px-6 py-4">{{ header }}</th>
              {% endfor %}
            {% else %}
              <th>Not implemented</th>
            {% endif %}
          </tr>
        </thead>
        <tbody>

            {% for pt_pk, results in table_data.row_data.items %}
            <tr class="bg-white border-b hover:bg-gray-100">
              {% for kpi_attr_name in table_data.headers %}
                <td class="px-6 py-4">
                    {% with result=results|get_item:kpi_attr_name %}
                      <p>
                        {% if kpi_attr_name == "nhs_number" %}
                            <span class="tooltip tooltip-right block" data-tip="View patient details">
                              <a href="{% url 'patient-update' pt_pk %}" class="block w-full h-full">
                              {{ result }}
                              <i class="fa-solid fa-arrow-up-right-from-square text-rcpch_strong_blue"></i>
                              </a>
                             </span>
                          </div>
                        {% elif kpi_attr_name == "total" %}
                          {{ result.0 }} / {{ result.1 }}
                        {% elif kpi_attr_name == "value" %}
                          {{ result }}
                        {% elif result is True %}
                            <i class="fa-solid fa-circle-check text-success"></i>
                        {% elif result is False %}
                          <i class="fa-solid fa-circle-exclamation text-error"></i>
                        {% else %}
                          <i class="fa-solid fa-ban text-muted"></i>
                        {% endif %}
                      </p>
                    {% endwith %}

                </td>
              {% endfor %}
                </tr>
            {% endfor %}


        </tbody>
      </table>
      </div>

    <style>
      {% comment %} Don't opacify the selected button {% endcomment %}
      button[disabled] {
        opacity: 1;
      }

      [disabled] {
        opacity: 0.5;
        pointer-events: none;
        cursor: progress;
      }

      {% comment %} Ensure all child elems in table styled the same {% endcomment %}
      [disabled] * {
        cursor: progress;
      }
    </style>
  </div>
    {% comment %} N PATIENTS BOTTOM CAP {% endcomment %}
    <div class="bg-rcpch_dark_blue py-5 text-white text-center">
      <div class="px-2">
          {% with n_pts=table_data.row_data|length %}
            {% if n_pts > 0 %}
              Total: <span class="font-bold">{{ table_data.row_data|length }} Patient{% if table_data.row_data|length > 1 %}s{% endif %}</span>
            {% else %}
              No patients
            {% endif %}
          {% endwith %}
      </div>
    </div>
</div>
