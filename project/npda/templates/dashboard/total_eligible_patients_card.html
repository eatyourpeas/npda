{% extends 'dashboard/base_card.html' %}
{% block card_title %}
  Total Eligible Patients
{% endblock card_title%}
{% block card_body %}
  <div id="total_eligible_pts_waffle_container" class="h-full">
  </div>


  <script>


    // Get the data from the Django context and parse it for JavaScript
    const data = {{ charts.total_eligible_patients_stratified_by_diabetes_type.data|safe }};

    // Define colours for the categories
    const colors = {
      'T1DM': '{{charts.total_eligible_patients_stratified_by_diabetes_type.colors.T1DM|safe}}',
      'T2DM': '{{charts.total_eligible_patients_stratified_by_diabetes_type.colors.T2DM|safe}}',
      'Other rare forms': '{{charts.total_eligible_patients_stratified_by_diabetes_type.colors.OTHER|safe}}',
    };

    // Function to resize the stage dynamically
    function resizeStage(stage, containerId, drawWaffle) {
      const container = document.getElementById(containerId);
      const width = container.offsetWidth;
      const height = container.offsetHeight;

      stage.width(width);
      stage.height(height);

      drawWaffle(stage, data); // Redraw the waffle chart with updated dimensions
    }

    // Create the Konva stage with initial dimensions
    const containerId = 'total_eligible_pts_waffle_container';
    const container = document.getElementById(containerId);

    const stage = new Konva.Stage({
      container: containerId, // Container ID
      width: container.offsetWidth, // Dynamically set width
      height: container.offsetHeight // Dynamically set height
    });

    // Draw the waffle chart
    function drawWaffle(stage, data) {
      // Clear the stage
      stage.destroyChildren();

      // Create a new layer
      const layer = new Konva.Layer();

      // Calculate proportions
      const total = Object.values(data).reduce((sum, value) => sum + value, 0);
      const proportions = Object.keys(data).map(key => ({
        key,
        color: colors[key],
        count: Math.round((data[key] / total) * 100)
      }));

      // Flatten the proportions into a grid array
      const gridArray = proportions.flatMap(({ color, count }) =>
        Array(count).fill(color)
      );

      // Define grid dimensions
      const gridSize = 10; // Grid is 10x10
      const squareSize = Math.min(stage.width(), stage.height()) / (gridSize + 1); // Dynamic square size
      const squareGap = squareSize / 8;

      // Draw squares
      gridArray.forEach((color, index) => {
        const row = Math.floor(index / gridSize);
        const col = index % gridSize;

        const square = new Konva.Rect({
          x: col * (squareSize + squareGap),
          y: row * (squareSize + squareGap),
          width: squareSize,
          height: squareSize,
          fill: color,
          stroke: 'black',
          strokeWidth: 0.5
        });

        layer.add(square);
      });

      // Add layer to the stage
      stage.add(layer);
    }

    // Initial draw
    drawWaffle(stage, data);

    // Add listener for window resize to adjust the stage and waffle chart
    window.addEventListener('resize', function () {
      resizeStage(stage, containerId, drawWaffle);
    });
  </script>
{% endblock %}




